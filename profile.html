<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="post-login.css">
    <title>Profile</title>
</head>
<body>
    <div class="nav">
        <img src="images/logo.png">
        <div class="nav-right">
            <div class="nav-content">
                <h5> Welcome, <span id="username"></span>!</h5>
                <button id="signout-btn">Sign Out</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <a href="dashboard.html">Dashboard</a>
        <a class="active" href="profile.html">Profile</a>
        <a href="history.html">History</a>
        <a href="Info.html">Information Forum</a>
    </div>

    <div class="content">
        <div class="profile">
            <h1>Your Profile</h1>
            <form id="profile-form">
                <label for="fname">First Name</label>
                <input type="text" id="fname" name="fname" placeholder="Enter your first name" required>

                <label for="lname">Last Name</label>
                <input type="text" id="lname" name="lname" placeholder="Enter your last name" required>

                <label for="contact">Contact</label>
                <input type="tel" id="contact" name="contact" placeholder="Enter mobile number" required>

                <label for="age">Age</label>
                <input type="number" id="age" name="age" placeholder="Enter your age" required>

                <label for="gender">Gender</label>
                <select id="gender" name="gender" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>

                <label for="mode">Mode</label>
                <div class="radio-Group">
                    <label><input type="radio" name="mode" value="student" required>Student</label>
                    <label><input type="radio" name="mode" value="employee" required>Employee</label>
                </div>

                <div class="buttons">
                    <button class="save-btn" type="submit">Save</button>
                    <button class="edit-btn">Edit</button>
                </div>
            </form>
        </div>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const BASE_URL = 'http://127.0.0.1:5000';

    // DOM references
    const fnameInput = document.getElementById("fname");
    const lnameInput = document.getElementById("lname");
    const contactInput = document.getElementById("contact");
    const ageInput = document.getElementById("age");
    const genderSelect = document.getElementById("gender");
    const modeRadios = document.getElementsByName("mode");
    const saveBtn = document.querySelector(".save-btn");
    const editBtn = document.querySelector(".edit-btn");
    const usernameDisplay = document.getElementById("username");
    const signoutBtn = document.getElementById("signout-btn");

    // Get current user
    const currentUserId = localStorage.getItem("user_id");

    if (!currentUserId) {
        alert("User not signed in. Redirecting to login...");
        window.location.href = "signin.html";
        return;
    }

    // Set username if available
    const savedName = localStorage.getItem("username");
    if (savedName) usernameDisplay.textContent = savedName;

    // Define user-specific key
    const profileKey = `profileData_${currentUserId}`;

    // Load profile specific to logged-in user
    const savedProfile = JSON.parse(localStorage.getItem(profileKey));

    if (savedProfile) {
        fillProfile(savedProfile);
        disableInputs();
        usernameDisplay.textContent = savedProfile.fname;
    } else {
        enableInputs();
    }

    // Save Profile
    saveBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        // selected mode
        let selectedMode = "";
        for (let radio of modeRadios) {
            if (radio.checked) selectedMode = radio.value;
        }

        // Validation
        if (fnameInput.value.trim() === "" || lnameInput.value.trim() === "") {
            alert("First and last name are required.");
            return;
        }
        if (!/^[0-9]{10}$/.test(contactInput.value.trim())) {
            alert("Please enter a valid 10-digit contact number.");
            return;
        }
        const ageVal = parseInt(ageInput.value, 10);
        if (isNaN(ageVal) || ageVal < 10) {
            alert("Please enter a valid age (must be 10 or older).");
            return;
        }
        if (!genderSelect.value) {
            alert("Please select your gender.");
            return;
        }
        if (!selectedMode) {
            alert("Please select your mode (Student or Employee).");
            return;
        }

        const payload = {
            user_id: Number(currentUserId),
            first_name: fnameInput.value.trim(),
            last_name: lnameInput.value.trim(),
            contact: contactInput.value.trim(),
            age: ageVal,
            gender: genderSelect.value,
            mode: selectedMode
        };

        try {
            const res = await fetch(`${BASE_URL}/profile`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || "Failed to save profile on server.");

            const localProfile = {
                fname: payload.first_name,
                lname: payload.last_name,
                contact: payload.contact,
                age: payload.age,
                gender: payload.gender,
                mode: payload.mode
            };

            // Save under user-specific key
            localStorage.setItem(profileKey, JSON.stringify(localProfile));
            localStorage.setItem("mode", payload.mode);
            localStorage.setItem("username", payload.first_name);

            fillProfile(localProfile);
            disableInputs();
            usernameDisplay.textContent = payload.first_name;
            alert("Profile saved successfully!");
        } catch (err) {
            console.error("Profile save error:", err);
            alert("Error saving profile: " + err.message);
        }
    });

    // Edit button
    editBtn.addEventListener("click", function (e) {
        e.preventDefault();
        enableInputs();
    });

    // Sign out
    signoutBtn.addEventListener("click", function () {
        if (currentUserId) {
            localStorage.removeItem(`profileData_${currentUserId}`);
        }
        localStorage.removeItem("username");
        localStorage.removeItem("mode");
        localStorage.removeItem("user_id");
        window.location.href = "signin.html";
    });

    // Helper functions
    function fillProfile(profile) {
        fnameInput.value = profile.fname || "";
        lnameInput.value = profile.lname || "";
        contactInput.value = profile.contact || "";
        ageInput.value = profile.age || "";
        genderSelect.value = profile.gender || "";
        for (let radio of modeRadios) {
            radio.checked = radio.value === profile.mode;
        }
    }

    function disableInputs() {
        [fnameInput, lnameInput, contactInput, ageInput, genderSelect, saveBtn].forEach(el => el.disabled = true);
        modeRadios.forEach(r => r.disabled = true);
    }

    function enableInputs() {
        [fnameInput, lnameInput, contactInput, ageInput, genderSelect, saveBtn].forEach(el => el.disabled = false);
        modeRadios.forEach(r => r.disabled = false);
    }
});
</script>


</body>
</html>
